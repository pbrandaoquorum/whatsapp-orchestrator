#!/usr/bin/env python3
"""
Script para testar diferentes cen√°rios de mensagens no endpoint POST /webhook/whatsapp
Simula um fluxo completo de plant√£o domiciliar
"""
import asyncio
import httpx
import json
import time
from typing import Dict, Any, List
from dataclasses import dataclass

@dataclass
class TestScenario:
    """Cen√°rio de teste"""
    name: str
    phone: str
    messages: List[Dict[str, str]]
    expected_flow: str
    description: str

class WhatsAppTester:
    """Testador do endpoint WhatsApp"""
    
    def __init__(self, base_url: str = "http://localhost:8000"):
        self.base_url = base_url
        self.session_results = {}
        
    async def send_message(self, phone: str, text: str, message_id: str = None) -> Dict[str, Any]:
        """Envia uma mensagem para o webhook"""
        if not message_id:
            message_id = f"msg_{int(time.time() * 1000)}"
            
        payload = {
            "message_id": message_id,
            "phoneNumber": phone,
            "text": text
        }
        
        headers = {
            "Content-Type": "application/json",
            "X-Idempotency-Key": f"test-{message_id}"
        }
        
        async with httpx.AsyncClient(timeout=30.0) as client:
            try:
                response = await client.post(
                    f"{self.base_url}/webhook/whatsapp",
                    json=payload,
                    headers=headers
                )
                
                return {
                    "status_code": response.status_code,
                    "response": response.json() if response.status_code == 200 else response.text,
                    "success": response.status_code == 200
                }
                
            except Exception as e:
                return {
                    "status_code": 0,
                    "response": str(e),
                    "success": False
                }
    
    async def run_scenario(self, scenario: TestScenario) -> Dict[str, Any]:
        """Executa um cen√°rio completo"""
        print(f"\nüéØ CEN√ÅRIO: {scenario.name}")
        print(f"üì± Telefone: {scenario.phone}")
        print(f"üìù Descri√ß√£o: {scenario.description}")
        print("-" * 60)
        
        results = []
        session_id = f"session_{scenario.phone.replace('+', '')}"
        
        for i, msg_data in enumerate(scenario.messages, 1):
            text = msg_data["text"]
            expected = msg_data.get("expected", "")
            
            print(f"\nüì§ Mensagem {i}: '{text}'")
            
            # Enviar mensagem
            result = await self.send_message(
                phone=scenario.phone,
                text=text,
                message_id=f"{scenario.name}_msg_{i}"
            )
            
            # Mostrar resultado
            if result["success"]:
                response_data = result["response"]
                print(f"‚úÖ Status: {result['status_code']}")
                print(f"ü§ñ Resposta: {response_data.get('message', '')[:100]}...")
                print(f"üîó Session: {response_data.get('session_id', 'N/A')}")
                print(f"‚û°Ô∏è  Pr√≥ximo: {response_data.get('next_action', 'N/A')}")
                
                if expected:
                    actual_action = response_data.get('next_action', '')
                    match = expected.lower() in actual_action.lower() if actual_action else False
                    print(f"üéØ Esperado: {expected} {'‚úÖ' if match else '‚ùå'}")
            else:
                print(f"‚ùå Erro: {result['status_code']} - {result['response']}")
            
            results.append(result)
            
            # Pequena pausa entre mensagens
            await asyncio.sleep(1)
        
        # Resumo do cen√°rio
        success_count = sum(1 for r in results if r["success"])
        print(f"\nüìä Resultado: {success_count}/{len(results)} mensagens processadas com sucesso")
        
        return {
            "scenario": scenario.name,
            "phone": scenario.phone,
            "total_messages": len(results),
            "successful_messages": success_count,
            "results": results
        }
    
    def create_scenarios(self) -> List[TestScenario]:
        """Cria cen√°rios de teste"""
        return [
            TestScenario(
                name="FLUXO_COMPLETO_SUCESSO",
                phone="+5511987654321",
                description="Fluxo completo: chegada ‚Üí confirma√ß√£o ‚Üí sinais vitais ‚Üí nota ‚Üí finaliza√ß√£o",
                expected_flow="complete",
                messages=[
                    {"text": "Oi, cheguei no plant√£o da Dona Maria. Como procedo?", "expected": "auxiliar"},
                    {"text": "Confirmo minha presen√ßa no local", "expected": "escala"},
                    {"text": "PA 130x85, FC 82 bpm, FR 20 irpm, Satura√ß√£o 96%, Temperatura 36.8¬∞C", "expected": "clinical"},
                    {"text": "Paciente consciente, orientada, colaborativa. Refere dor leve em MMII. Deambula com aux√≠lio.", "expected": "notas"},
                    {"text": "Plant√£o finalizado. Como envio o relat√≥rio?", "expected": "finalizar"}
                ]
            ),
            
            TestScenario(
                name="CANCELAMENTO_PLANTAO",
                phone="+5511987654322",
                description="Cancelamento de plant√£o por imprevisto",
                expected_flow="cancel",
                messages=[
                    {"text": "N√£o posso ir ao plant√£o hoje, tive um imprevisto familiar", "expected": "escala"},
                    {"text": "Sim, confirmo o cancelamento", "expected": "auxiliar"}
                ]
            ),
            
            TestScenario(
                name="SINAIS_VITAIS_INCREMENTAIS",
                phone="+5511987654323", 
                description="Coleta incremental de sinais vitais",
                expected_flow="clinical",
                messages=[
                    {"text": "Cheguei no plant√£o", "expected": "auxiliar"},
                    {"text": "Confirmo presen√ßa", "expected": "escala"},
                    {"text": "PA 120x80", "expected": "clinical"},
                    {"text": "FC 78 bpm", "expected": "clinical"},
                    {"text": "Satura√ß√£o 97%", "expected": "clinical"},
                    {"text": "Temperatura 36.5¬∞C", "expected": "clinical"},
                    {"text": "FR 18 irpm", "expected": "clinical"}
                ]
            ),
            
            TestScenario(
                name="NOTA_CLINICA_DETALHADA",
                phone="+5511987654324",
                description="Teste com nota cl√≠nica detalhada",
                expected_flow="clinical",
                messages=[
                    {"text": "Estou no plant√£o, confirmo presen√ßa", "expected": "escala"},
                    {"text": "Sinais vitais: PA 125x80, FC 75, FR 16, Sat 98%, Temp 36.2", "expected": "clinical"},
                    {"text": """Paciente apresenta quadro est√°vel. Consciente, orientada no tempo e espa√ßo. 
                            Refere melhora da dor lombar ap√≥s medica√ß√£o. Deambula sem aux√≠lio. 
                            Alimentou-se bem no almo√ßo. Humor est√°vel, colaborativa com os cuidados. 
                            Pele √≠ntegra, sem les√µes. Elimina√ß√µes fisiol√≥gicas normais.""", "expected": "notas"}
                ]
            ),
            
            TestScenario(
                name="MENSAGENS_AMBIGUAS",
                phone="+5511987654325",
                description="Teste com mensagens amb√≠guas e indefinidas",
                expected_flow="auxiliar",
                messages=[
                    {"text": "Ol√°", "expected": "auxiliar"},
                    {"text": "N√£o entendi", "expected": "auxiliar"},
                    {"text": "Preciso de ajuda", "expected": "auxiliar"},
                    {"text": "Como funciona?", "expected": "auxiliar"},
                    {"text": "Oi, tudo bem?", "expected": "auxiliar"}
                ]
            ),
            
            TestScenario(
                name="CONFIRMACOES_SIMPLES",
                phone="+5511987654326",
                description="Teste de confirma√ß√µes simples (sim/n√£o)",
                expected_flow="confirmation",
                messages=[
                    {"text": "Cheguei", "expected": "auxiliar"},
                    {"text": "Sim", "expected": "auxiliar"},
                    {"text": "N√£o", "expected": "auxiliar"},
                    {"text": "Ok", "expected": "auxiliar"},
                    {"text": "Pode ser", "expected": "auxiliar"}
                ]
            )
        ]
    
    async def run_health_check(self) -> bool:
        """Verifica se o servidor est√° rodando"""
        try:
            async with httpx.AsyncClient(timeout=5.0) as client:
                response = await client.get(f"{self.base_url}/healthz")
                return response.status_code == 200
        except:
            return False
    
    async def run_all_scenarios(self):
        """Executa todos os cen√°rios de teste"""
        print("üß™ TESTE DE CEN√ÅRIOS - WhatsApp Orchestrator")
        print("=" * 70)
        
        # Verificar se servidor est√° rodando
        print("üîç Verificando servidor...")
        if not await self.run_health_check():
            print("‚ùå Servidor n√£o est√° rodando!")
            print("üöÄ Execute: uvicorn app.api.main:app --reload")
            return
        
        print("‚úÖ Servidor est√° rodando!")
        
        # Executar cen√°rios
        scenarios = self.create_scenarios()
        all_results = []
        
        for scenario in scenarios:
            try:
                result = await self.run_scenario(scenario)
                all_results.append(result)
            except Exception as e:
                print(f"‚ùå Erro no cen√°rio {scenario.name}: {e}")
        
        # Relat√≥rio final
        print("\n" + "=" * 70)
        print("üìä RELAT√ìRIO FINAL")
        print("=" * 70)
        
        total_scenarios = len(all_results)
        total_messages = sum(r["total_messages"] for r in all_results)
        total_successful = sum(r["successful_messages"] for r in all_results)
        
        print(f"üìà Cen√°rios executados: {total_scenarios}")
        print(f"üì® Total de mensagens: {total_messages}")
        print(f"‚úÖ Mensagens bem-sucedidas: {total_successful}")
        print(f"üìä Taxa de sucesso: {(total_successful/total_messages)*100:.1f}%")
        
        print("\nüéØ Resumo por cen√°rio:")
        for result in all_results:
            success_rate = (result["successful_messages"] / result["total_messages"]) * 100
            status = "‚úÖ" if success_rate == 100 else "‚ö†Ô∏è" if success_rate >= 80 else "‚ùå"
            print(f"  {status} {result['scenario']}: {result['successful_messages']}/{result['total_messages']} ({success_rate:.0f}%)")
        
        if total_successful == total_messages:
            print("\nüéâ TODOS OS TESTES PASSARAM!")
            print("‚úÖ Sistema funcionando perfeitamente!")
        else:
            print(f"\n‚ö†Ô∏è  {total_messages - total_successful} mensagens falharam")
            print("üîç Verifique os logs para mais detalhes")

async def main():
    """Fun√ß√£o principal"""
    tester = WhatsAppTester()
    await tester.run_all_scenarios()

if __name__ == "__main__":
    asyncio.run(main())
